<subsystem>
    <import>rtt_barrett_hand_controller_msgs</import>
    <import>eigen_typekit</import>
    <import>rtt_control_msgs</import>
    <import>controller_common</import>
    <import>velma_controller</import>
    <import>rtt_cartesian_trajectory_msgs</import>
    <import>rtt_std_msgs</import>
    <import>rtt_tf</import>
    <import>port_operations</import>
    <import>force_control</import>
    <import>rtt_force_control_msgs</import>
    <import>velma_core_cs</import>
    <import>rtt_velma_core_cs_ve_body_msgs</import>
    <import>rtt_velma_core_cs_ve_body_subsystem_ports</import>
    <import>rtt_velma_core_cs_task_cs_msgs</import>
    <import>rtt_velma_core_cs_task_cs_subsystem_ports</import>


    <component name="HeadPanVelocityLimiter"    type="VelocityLimiter" />
    <component name="HeadTiltVelocityLimiter"   type="VelocityLimiter" />

    <component name="Jc"        type="VectorConcate1_7_7_0" running="true" />
    <component name="Jvc"       type="VectorConcate1_7_7_0" running="true" />
    <component name="JcAll"     type="VectorConcate15_2_8_8" running="true" />
    <component name="JvcAll"    type="VectorConcate15_2_8_8" running="true" />
    <component name="Dwr"       type="DecimatorWrench" />
    <component name="Dwl"       type="DecimatorWrench" />
    <component name="Mass"      type="MassTest15_2" running="true" >
        <service>robot</service>
    </component>

    <component name="HeadTrajectoryGeneratorJoint" type="InternalSpaceSplineTrajectoryGeneratorVelmaHead" />

    <component name="HeadPosAggregate"      type="PortDoubleAggregate2" running="true" />
    <component name="HeadPosSplit"          type="PortDoubleSplit2" running="true" />

<!--
#    <component name="TorquePubRight"   type="TorquePublisher7" />
#    <component name="TorquePubLeft"    type="TorquePublisher7" />
#    <component name="VG"       type="VelmaGrav" />
#TGR.start();
-->
    <component name="TGR"       type="TriggerGenerator" />
    <component name="Sd"        type="ScalarDummy" running="true" />
    <component name="Vd8"       type="VectorDummy8" running="true" />
    <component name="Vd2"       type="VectorDummy2" running="true" />
    <component name="Ts"        type="VectorSplit1_7_7_0" running="true" />
    <component name="TJ"        type="TorsoTeleopJoy" running="true" />

    <component name="HeadVelAggregate"      type="PortDoubleAggregate2" running="true" />
    <component name="HeadPosSplit"          type="PortDoubleSplit2" running="true" />

    <component name="TorsoPosAggregate"     type="PortDoubleAggregate1" running="true" />
    <component name="TorsoVelAggregate"     type="PortDoubleAggregate1" running="true" />
    <component name="TorsoTrqSplit"         type="PortDoubleSplit1" running="true" />
    <component name="CImp"                  type="CartesianImpedance15_2" >
        <service>robot</service>
    </component>
    <component name="PoseIntRight"          type="CartesianInterpolatorVelma" />
    <component name="PoseIntLeft"           type="CartesianInterpolatorVelma" />
    <component name="ToolIntRight"          type="CartesianInterpolatorVelma" running="true" />
    <component name="ToolIntLeft"           type="CartesianInterpolatorVelma" running="true" />
    <component name="ImpedanceIntRight"     type="CartesianImpedanceInterpolatorVelma" running="true" />
    <component name="ImpedanceIntLeft"      type="CartesianImpedanceInterpolatorVelma" running="true" />
    <component name="JntImp"                type="JointImpedance15" />
    <component name="FK"                    type="VelmaFK" running="true" >
        <service>robot</service>
    </component>
    <component name="RightForceTransformation"  type="ForceTransformation" />
    <component name="LeftForceTransformation"   type="ForceTransformation" />
    <component name="RightForceControl"         type="ForceControlLaw" />
    <component name="LeftForceControl"          type="ForceControlLaw" />
    <component name="TrajectoryGeneratorJoint"  type="InternalSpaceSplineTrajectoryGeneratorVelmaBody" />
    <component name="JntLimit"                  type="JointLimitAvoidance15" />
    <component name="safe"      type="velma_core_cs_types::SafeComponent" />
    <component name="idle"      type="velma_core_cs_types::IdleComponent" />

    <io_buffer alias="b_st"     name="velma_core_cs_ve_body_msgs_Status" />

    <io_buffer alias="b_cmd"    name="velma_core_cs_ve_body_msgs_Command" />

    <io_buffer alias="st" name="velma_core_cs_task_cs_msgs_Status" />
    <io_buffer alias="cmd" name="velma_core_cs_task_cs_msgs_Command" />

    <connection from="b_stSplit.tMotor_q_OUTPORT" to="TorsoPosAggregate.InputPort_0" />
    <connection from="b_stSplit.tMotor_dq_OUTPORT" to="TorsoVelAggregate.InputPort_0" />
    <connection from="TorsoTrqSplit.OutputPort_0" to="b_cmdConcate.tMotor_i_INPORT" />

    <connection from="b_stSplit.hpMotor_q_OUTPORT" to="HeadPosAggregate.InputPort_0" />
    <connection from="b_stSplit.hpMotor_dq_OUTPORT" to="HeadVelAggregate.InputPort_0" />

<!--    <connection from="Vd2.vector_OUTPORT" to="HeadPosSplit.InputPort" />-->

<!--    <connection from="HeadPosSplit.OutputPort_0" to="b_cmdConcate.hpMotor_dq_INPORT" /> TODO: check if dq is used-->
    <connection from="HeadPosSplit.OutputPort_0" to="HeadPanVelocityLimiter.Position_INPORT" />
    <connection from="b_stSplit.htMotor_q_OUTPORT" to="HeadTiltVelocityLimiter.PositionMsr_INPORT" />

    <connection from="b_stSplit.htMotor_q_OUTPORT" to="HeadPosAggregate.InputPort_1" />
    <connection from="b_stSplit.htMotor_dq_OUTPORT" to="HeadVelAggregate.InputPort_1" />
    <connection from="HeadPosSplit.OutputPort_1" to="HeadTiltVelocityLimiter.Position_INPORT" />
<!--    <connection from="HeadPosSplit.OutputPort_1" to="b_cmdConcate.htMotor_dq_INPORT" /> TODO: check if dq is used-->

<!--
    <connection from="Sd.scalar_OUTPORT" to="HeadTiltVelocityLimiter.PositionMsr_INPORT" />
    <connection from="Sd.scalar_OUTPORT" to="HeadTiltVelocityLimiter.Position_INPORT" />
    <connection from="Sd.scalar_OUTPORT" to="HeadPanVelocityLimiter.PositionMsr_INPORT" />
    <connection from="Sd.scalar_OUTPORT" to="HeadPanVelocityLimiter.Position_INPORT" />
-->

    <connection from="b_stSplit.hpMotor_q_OUTPORT" to="HeadPanVelocityLimiter.PositionMsr_INPORT" />
    <connection from="HeadPanVelocityLimiter.Position_OUTPORT" to="b_cmdConcate.hpMotor_q_INPORT" />
    <connection from="HeadTiltVelocityLimiter.Position_OUTPORT" to="b_cmdConcate.htMotor_q_INPORT" />
<!--    <connection from="Sd.scalar_OUTPORT" to="b_cmdConcate.hpMotor_q_INPORT" />
    <connection from="Sd.scalar_OUTPORT" to="b_cmdConcate.htMotor_q_INPORT" />-->

    <connection from="b_stSplit.rArm_q_OUTPORT" to="Jc.In1" />
    <connection from="b_stSplit.lArm_q_OUTPORT" to="Jc.In2" />
    <connection from="b_stSplit.rArm_dq_OUTPORT" to="Jvc.In1" />
    <connection from="b_stSplit.lArm_dq_OUTPORT" to="Jvc.In2" />
    <connection from="Vd8.vector_OUTPORT" to="JcAll.In2" />
    <connection from="Vd8.vector_OUTPORT" to="JcAll.In3" />
    <connection from="Vd8.vector_OUTPORT" to="JvcAll.In2" />
    <connection from="Vd8.vector_OUTPORT" to="JvcAll.In3" />
    <connection from="Ts.Out1" to="b_cmdConcate.rArm_t_INPORT" />
    <connection from="Ts.Out2" to="b_cmdConcate.lArm_t_INPORT" />
    <connection from="b_stSplit.rArm_w_OUTPORT" to="Dwr.In" />
    <connection from="b_stSplit.lArm_w_OUTPORT" to="Dwl.In" />
    <connection from="b_stSplit.lArm_mmx_OUTPORT"  to="Mass.MassMatrixLeft_INPORT" />
    <connection from="b_stSplit.rArm_mmx_OUTPORT"  to="Mass.MassMatrixRight_INPORT" />
    <connection from="Jc.Out" to="Mass.JointPosition_INPORT" />
<!--
    <connection from="HeadPosAggregate.OutputPort" to="JcAll.In1" />
    <connection from="HeadVelAggregate.OutputPort" to="JvcAll.In1" />
-->
    <connection from="Vd2.vector_OUTPORT" to="JcAll.In1" />
    <connection from="Vd2.vector_OUTPORT" to="JvcAll.In1" />
    <connection from="TorsoPosAggregate.OutputPort" to="Jc.In0" />
    <connection from="TorsoVelAggregate.OutputPort" to="Jvc.In0" />
    <connection from="Jc.Out" to="JcAll.In0" />
    <connection from="Jvc.Out" to="JvcAll.In0" />
    <connection from="Ts.Out0" to="TorsoTrqSplit.InputPort" />
    <connection from="Jc.Out" to="CImp.JointPosition_INPORT" />
    <connection from="Jvc.Out" to="CImp.JointVelocity_INPORT" />
    <connection from="Mass.MassMatrix_OUTPORT" to="CImp.MassMatrixInv_INPORT" />
    <connection from="CImp.JointTorqueCommand_OUTPORT" to="Ts.In" />
    <connection from="PoseIntRight.CartesianPositionCommand_OUTPORT" to="CImp.CartPositionCommand0_INPORT" />
    <connection from="cmdSplit.cart_r_pose_OUTPORT" to="PoseIntRight.CartesianTrajectoryCommand_INPORT" />
    <connection from="PoseIntRight.generator_status_OUTPORT" to="stConcate.rCart_status_INPORT" />
    <connection from="PoseIntRight.CartesianPositionCommand_OUTPORT" to="stConcate.rCart_cmd_INPORT" />
    <connection from="PoseIntLeft.CartesianPositionCommand_OUTPORT" to="CImp.CartPositionCommand1_INPORT" />
    <connection from="cmdSplit.cart_l_pose_OUTPORT" to="PoseIntLeft.CartesianTrajectoryCommand_INPORT" />
    <connection from="PoseIntLeft.generator_status_OUTPORT" to="stConcate.lCart_status_INPORT" />
    <connection from="PoseIntLeft.CartesianPositionCommand_OUTPORT" to="stConcate.lCart_cmd_INPORT" />
    <connection from="ToolIntRight.CartesianPositionCommand_OUTPORT" to="CImp.ToolPositionCommand0_INPORT" />
    <connection from="cmdSplit.cart_r_tool_OUTPORT" to="ToolIntRight.CartesianTrajectoryCommand_INPORT" />
    <connection from="ToolIntLeft.CartesianPositionCommand_OUTPORT" to="CImp.ToolPositionCommand1_INPORT" />
    <connection from="cmdSplit.cart_l_tool_OUTPORT" to="ToolIntLeft.CartesianTrajectoryCommand_INPORT" />
    <connection from="ImpedanceIntRight.CartesianImpedanceCommand_OUTPORT" to="CImp.CartImpedanceCommand0_INPORT" />
    <connection from="cmdSplit.cart_r_imp_OUTPORT" to="ImpedanceIntRight.CartesianImpedanceTrajectoryCommand_INPORT" />
    <connection from="ImpedanceIntLeft.CartesianImpedanceCommand_OUTPORT" to="CImp.CartImpedanceCommand1_INPORT" />
    <connection from="cmdSplit.cart_l_imp_OUTPORT" to="ImpedanceIntLeft.CartesianImpedanceTrajectoryCommand_INPORT" />
    <connection from="Jc.Out" to="JntImp.JointPosition_INPORT" />
    <connection from="Jvc.Out" to="JntImp.JointVelocity_INPORT" />
    <connection from="Mass.MassMatrix_OUTPORT" to="JntImp.MassMatrix_INPORT" />
    <connection from="JntImp.JointTorqueCommand_OUTPORT" to="Ts.In" />
    <connection from="ToolIntLeft.CartesianPositionCommand_OUTPORT" to="FK.LeftTool_INPORT" />
    <connection from="ToolIntRight.CartesianPositionCommand_OUTPORT" to="FK.RightTool_INPORT" />
    <connection from="Jc.Out" to="FK.JointPosition_INPORT" />
    <connection from="FK.LeftPosition_OUTPORT" to="PoseIntLeft.CartesianPosition_INPORT" />
    <connection from="FK.RightPosition_OUTPORT" to="PoseIntRight.CartesianPosition_INPORT" />
    <connection from="FK.RightWrist_OUTPORT" to="RightForceTransformation.CurrentWristPose" />
    <connection from="b_stSplit.rFt_sfw_OUTPORT" to="RightForceTransformation.CurrentSensorSlowFilteredWrench" />
    <connection from="b_stSplit.rFt_rw_OUTPORT" to="RightForceTransformation.CurrentSensorFastFilteredWrench" />
    <connection from="ToolIntRight.CartesianPositionCommand_OUTPORT" to="RightForceTransformation.Tool" />
    <connection from="FK.LeftWrist_OUTPORT" to="LeftForceTransformation.CurrentWristPose" />
    <connection from="b_stSplit.lFt_sfw_OUTPORT" to="LeftForceTransformation.CurrentSensorSlowFilteredWrench" />
    <connection from="b_stSplit.lFt_rw_OUTPORT" to="LeftForceTransformation.CurrentSensorFastFilteredWrench" />
    <connection from="ToolIntLeft.CartesianPositionCommand_OUTPORT" to="LeftForceTransformation.Tool" />
    <connection from="RightForceControl.OutputEndEffectorPose" to="CImp.CartPositionCommand0_INPORT" />
    <connection from="FK.RightPosition_OUTPORT" to="RightForceControl.CurrentEndEffectorPose" />
    <connection from="RightForceTransformation.OutputEndEffectorWrench" to="RightForceControl.CurrentEndEffectorWrench" />
    <connection from="LeftForceControl.OutputEndEffectorPose" to="CImp.CartPositionCommand1_INPORT" />
    <connection from="FK.LeftPosition_OUTPORT" to="LeftForceControl.CurrentEndEffectorPose" />
    <connection from="LeftForceTransformation.OutputEndEffectorWrench" to="LeftForceControl.CurrentEndEffectorWrench" />
    <connection from="Jc.Out" to="TrajectoryGeneratorJoint.JointPosition_INPORT" />
    <connection from="TrajectoryGeneratorJoint.JointPositionCommand_OUTPORT" to="JntImp.JointPositionCommand_INPORT" />
    <connection from="TrajectoryGeneratorJoint.JointPositionCommand_OUTPORT" to="stConcate.jnt_q_desired_INPORT" />
    <connection from="TrajectoryGeneratorJoint.generator_status_OUTPORT" to="stConcate.jnt_status_INPORT" />
    <connection from="TrajectoryGeneratorJoint.stiffness_command_OUTPORT" to="JntImp.JointStiffnessCommand_INPORT" />
    <connection from="cmdSplit.jnt_OUTPORT" to="TrajectoryGeneratorJoint.jnt_INPORT" />
    <connection from="Jc.Out" to="JntLimit.JointPosition_INPORT" />
    <connection from="Jvc.Out" to="JntLimit.JointVelocity_INPORT" />
    <connection from="Mass.MassMatrix_OUTPORT" to="JntLimit.MassMatrix_INPORT" />
    <connection from="JntLimit.JointTorqueCommand_OUTPORT" to="CImp.NullSpaceTorqueCommand_INPORT" />
    <connection from="master_component.b_st_OUTPORT" to="safe.status_INPORT" />
    <connection from="Jc.Out" to="safe.JointPosition_INPORT" />
    <connection from="safe.JointPositionCommand_OUTPORT" to="JntImp.JointPositionCommand_INPORT" />
    <connection from="safe.JointStiffnessCommand_OUTPORT" to="JntImp.JointStiffnessCommand_INPORT" />
    <connection from="idle.cmd_sc_OUTPORT" to="b_cmdConcate.sc_INPORT" />
    <connection from="master_component.b_st_OUTPORT" to="idle.status_INPORT" />
    <connection from="idle.JointTorqueCommand_OUTPORT" to="Ts.In" />
    <connection from="idle.cmd_hpMotor_q_OUTPORT" to="b_cmdConcate.hpMotor_q_INPORT" />
    <connection from="idle.cmd_htMotor_q_OUTPORT" to="b_cmdConcate.htMotor_q_INPORT" />
    <connection from="b_stSplit.test_OUTPORT" to="b_cmdConcate.test_INPORT" />
    <ros_stream port="b_stSplit._OUTPORT" topic="/velma_core_cs/b_st" />
    <connection from="JcAll.Out" to="stConcate.q_INPORT" />
    <connection from="JvcAll.Out" to="stConcate.dq_INPORT" />
    <connection from="cmdSplit.hand_r_OUTPORT" to="b_cmdConcate.rHand_INPORT" />
    <connection from="cmdSplit.hand_l_OUTPORT" to="b_cmdConcate.lHand_INPORT" />
    <connection from="b_stSplit.rHand_OUTPORT" to="stConcate.hand_r_INPORT" />
    <connection from="b_stSplit.lHand_OUTPORT" to="stConcate.hand_l_INPORT" />
    <connection from="b_stSplit.p_OUTPORT" to="stConcate.p_INPORT" />
    <connection from="b_stSplit.f_OUTPORT" to="stConcate.f_INPORT" />
    <ros_stream port="b_cmdConcate.msg_OUTPORT" topic="/velma_core_cs/ve_body_msgs_CommandConcate" />


    <connection from="HeadPosAggregate.OutputPort" to="HeadTrajectoryGeneratorJoint.JointPosition_INPORT" />
    <connection from="HeadTrajectoryGeneratorJoint.JointPositionCommand_OUTPORT" to="HeadPosSplit.InputPort" />
    <connection from="cmdSplit.head_OUTPORT" to="HeadTrajectoryGeneratorJoint.jnt_INPORT" />


<!--
//    <connection from="TGR.Trigger" to="EC.torso.subnode0.DigitalOutput1" />
//    <connection from="TGR.Trigger" to="EC.torso.subnode0.DigitalOutput2" />
#    <connection from="b_stSplit.rHand_q_OUTPORT" to="JcAll.In2" />
#    <connection from="b_stSplit.lHand_q_OUTPORT" to="JcAll.In3" />
#    <connection from="b_stSplit.rHand_q_OUTPORT" to="JvcAll.In2" />
#    <connection from="b_stSplit.lHand_q_OUTPORT" to="JvcAll.In3" />
#    <connection from="b_stSplit.rArm_t_OUTPORT" to="TorquePubRight.InJointTorque" />
#    <connection from="b_stSplit.rArm_gt_OUTPORT" to="TorquePubRight.InGravityTorque" />
#    <connection from="b_stSplit.lArm_t_OUTPORT" to="TorquePubLeft.InJointTorque" />
#    <connection from="b_stSplit.lArm_gt_OUTPORT" to="TorquePubLeft.InGravityTorque" />
#    <connection from="b_stSplit.lArm_gt_OUTPORT" to="VG.GravTrqLeft" />
#    <connection from="b_stSplit.rArm_gt_OUTPORT" to="VG.GravTrqRight" />
#    <ros_stream port="b_stSplit.rArm_w_OUTPORT" topic="/right_arm/wrench" />
#    <ros_stream port="b_stSplit.lArm_w_OUTPORT" topic="/left_arm/wrench" />
#    <ros_stream port="Dwr.Out" topic="/right_arm/wrench" />
#    <ros_stream port="Dwl.Out" topic="/left_arm/wrench" />
#    <ros_stream port="TJ.Joy_INPORT" topic="/joy" />
#    <ros_stream port="TGR.TriggerStamp" topic="/camera_trigger_stamp" />
#    <connection from="FK.RightPosition_OUTPORT" to="TfPub.In4" />
#    <connection from="FK.LeftPosition_OUTPORT" to="TfPub.In5" />
#    <ros_stream port="RightForceTransformation.ToolGravityParam" topic="/right_arm/tg_param" />
#    <ros_stream port="RightForceTransformation.OutputEndEffectorWrench" topic="/right_arm/transformed_wrench" />
#    <ros_stream port="LeftForceTransformation.ToolGravityParam" topic="/left_arm/tg_param" />
#    <ros_stream port="LeftForceTransformation.OutputEndEffectorWrench" topic="/left_arm/transformed_wrench" />
//    <connection from="RightForceControl.IsSynchronisedIn" to="Irp6otHardwareInterface.IsSynchronised" />
//    <connection from="RightForceControl.GeneratorActiveOut" to="Irp6otHardwareInterface.GeneratorActiveIn" />
#    <ros_stream port="RightForceControl.CurrentFclParam" topic="/right_arm/fcl_param" />
//    <connection from="LeftForceControl.IsSynchronisedIn" to="Irp6otHardwareInterface.IsSynchronised" />
//    <connection from="LeftForceControl.GeneratorActiveOut" to="Irp6otHardwareInterface.GeneratorActiveIn" />
#    <ros_stream port="LeftForceControl.CurrentFclParam" topic="/left_arm/fcl_param" />
//    <connection from="TJ.NullSpaceTorqueCommand_OUTPORT" to="JntLimit.NullSpaceTorqueCommand_INPORT" />
#    <connection from="VG.GravTrq" to="JntLimit.NullSpaceTorqueCommand_INPORT" />
-->
</subsystem>

